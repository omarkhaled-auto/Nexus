---
phase: 11-integration-testing
plan: 03
type: execute
depends_on: ["11-02"]
files_modified: [tests/integration/agents/planner.test.ts, tests/integration/agents/coder.test.ts, tests/integration/agents/reviewer.test.ts, tests/integration/flows/genesis.test.ts, tests/integration/flows/evolution.test.ts]
---

<objective>
Create agent integration tests and full-flow integration tests.

Purpose: Test individual agent types with real dependencies, then test complete Genesis and Evolution flows end-to-end.
Output: 15 agent tests + 10 flow tests = 25 integration tests covering the core execution paths.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/11-integration-testing/11-CONTEXT.md
@.planning/phases/11-integration-testing/11-RESEARCH.md
@.planning/phases/11-integration-testing/11-02-SUMMARY.md

**Agent architecture (from Phase 3):**
- AgentRunner base class with tool loop
- CoderRunner: writes code, runs tools
- TesterRunner: writes and runs tests
- ReviewerRunner: reviews code quality
- MergerRunner: merges approved changes

**Flow architecture:**
- Genesis: Interview → RequirementExtractor → TaskDecomposer → AgentPool → QA → Merge
- Evolution: FeatureStore → TaskDecomposer → AgentPool → QA → Merge

**Key source files:**
@src/execution/agents/AgentRunner.ts
@src/execution/agents/CoderRunner.ts
@src/interview/InterviewEngine.ts
@src/orchestration/coordinator/NexusCoordinator.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Agent integration tests (Planner, Coder, Reviewer)</name>
  <files>tests/integration/agents/planner.test.ts, tests/integration/agents/coder.test.ts, tests/integration/agents/reviewer.test.ts</files>
  <action>
**planner.test.ts** (5 tests):
1. `should decompose feature into executable tasks` - Feature in → tasks out with dependencies
2. `should respect complexity limits per task` - No task exceeds 30-min estimate
3. `should emit planning events` - EventBus receives planning:started, planning:completed
4. `should handle ambiguous requirements` - Vague input → asks for clarification or makes reasonable assumptions
5. `should integrate with TimeEstimator for calibration` - Historical data affects estimates

**coder.test.ts** (5 tests):
1. `should write code to specified file` - Task → file created with implementation
2. `should use tool loop for multi-step tasks` - Complex task → multiple tool calls
3. `should handle tool errors gracefully` - Tool fails → recovery or clear error
4. `should emit progress events during execution` - EventBus receives coder:progress
5. `should integrate with BuildVerifier after writing` - Code written → build triggered

**reviewer.test.ts** (5 tests):
1. `should review code changes` - Diff provided → review feedback
2. `should approve good code` - Quality code → approval signal
3. `should request changes for issues` - Problems found → change requests
4. `should integrate with QALoopEngine` - Review result → QA loop continues/retries
5. `should emit review events` - EventBus receives review:started, review:completed

All agents use MSW-mocked LLM APIs. Test real integration with EventBus and file system (temp dirs).
  </action>
  <verify>npm test -- --run tests/integration/agents/ (15 tests pass)</verify>
  <done>15 agent tests pass, each agent type verified with real dependencies</done>
</task>

<task type="auto">
  <name>Task 2: Genesis flow integration test</name>
  <files>tests/integration/flows/genesis.test.ts</files>
  <action>
Create 5 tests verifying the complete Genesis mode flow:

1. `should complete interview to requirements extraction` - InterviewEngine conversation → RequirementExtractor → stored requirements
2. `should decompose requirements into tasks` - Requirements → TaskDecomposer → task tree with dependencies
3. `should execute tasks through agent pool` - Tasks queued → agents assigned → code written
4. `should run QA loop on completed tasks` - Task done → build/lint/test/review cycle
5. `should complete full Genesis flow end-to-end` - New project → interview → requirements → tasks → code → QA → done

This is a high-complexity test that exercises:
- InterviewEngine + RequirementExtractor
- TaskDecomposer + DependencyResolver
- AgentPool + CoderRunner + TesterRunner
- QALoopEngine + all quality tools

Use temp project directory, MSW for LLMs, real components for everything else.
Set reasonable timeouts (30s per test) due to multi-step nature.
  </action>
  <verify>npm test -- --run tests/integration/flows/genesis.test.ts (5 tests pass)</verify>
  <done>5 Genesis flow tests pass, full end-to-end path verified</done>
</task>

<task type="auto">
  <name>Task 3: Evolution flow integration test</name>
  <files>tests/integration/flows/evolution.test.ts</files>
  <action>
Create 5 tests verifying the complete Evolution mode flow:

1. `should load features from feature store` - FeatureStore populated → features available
2. `should decompose feature into tasks` - Feature selected → TaskDecomposer → tasks
3. `should execute tasks respecting wave order` - Dependencies respected, parallel where possible
4. `should handle human checkpoint integration` - Checkpoint reached → HumanReviewService triggered → can approve/reject
5. `should complete full Evolution flow end-to-end` - Existing project → feature → tasks → code → QA → merge

This flow differs from Genesis by:
- Starting from existing FeatureStore (not interview)
- Using Evolution mode routing in NexusCoordinator
- Integrating with HumanReviewService for checkpoints

Use temp project with pre-seeded features, MSW for LLMs.
  </action>
  <verify>npm test -- --run tests/integration/flows/evolution.test.ts (5 tests pass)</verify>
  <done>5 Evolution flow tests pass, full end-to-end path verified</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm test -- --run tests/integration/agents/` passes 15 tests
- [ ] `npm test -- --run tests/integration/flows/` passes 10 tests
- [ ] All 25 tests pass together without conflicts
- [ ] No flaky tests (run 3 times)
- [ ] Genesis and Evolution flows tested end-to-end
</verification>

<success_criteria>

- 15 agent integration tests passing
- 10 flow integration tests passing (5 Genesis, 5 Evolution)
- Full end-to-end flows verified
- MSW mocks LLM APIs effectively
- Tests run in reasonable time (<2min total)
</success_criteria>

<output>
After completion, create `.planning/phases/11-integration-testing/11-03-SUMMARY.md`
</output>
