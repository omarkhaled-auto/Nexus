---
phase: 01-foundation
plan: 06
type: tdd
depends_on: ["01-05"]
files_modified: [src/infrastructure/git/GitService.ts, src/infrastructure/git/GitService.test.ts]
---

<objective>
Implement GitService using Test-Driven Development.

Purpose: Create a comprehensive git service that handles all version control operations for agents working in isolated worktrees.
Output: Fully tested GitService with branch, commit, merge, diff operations.
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-plan.md
./.claude/get-shit-done/templates/summary.md
./.claude/get-shit-done/references/tdd.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation/01-CONTEXT.md

**Reference specifications:**
- Master Book Section 4.2 BUILD-003: Infrastructure Layer (GitService ~4h)
- Library: simple-git

**Key implementation notes from Master Book:**
- Support custom git binary path (for Electron bundling)
- Branch naming pattern: nexus/task/{taskId}/{timestamp}
- Clean error handling with typed exceptions
- Target: 15 tests, 250-300 LOC

**Prior plan reference:**
@.planning/phases/01-foundation/01-05-SUMMARY.md (when available)
</context>

<feature>
  <name>GitService</name>
  <files>src/infrastructure/git/GitService.ts, src/infrastructure/git/GitService.test.ts</files>
  <behavior>
GitService provides git operations for agents:

**Repository status:**
1. isRepository(path: string): Promise<boolean>
   - Check if path is inside a git repository

2. status(path?: string): Promise<GitStatus>
   - Get current branch, staged, unstaged, untracked files

3. currentBranch(path?: string): Promise<string>
   - Get name of current branch

**Branch operations:**
4. createBranch(name: string, from?: string): Promise<void>
   - Create new branch from source (default: current)
   - Does NOT checkout the branch

5. checkoutBranch(name: string): Promise<void>
   - Switch to existing branch

6. deleteBranch(name: string, force?: boolean): Promise<void>
   - Delete a branch (force for unmerged)

7. listBranches(): Promise<BranchInfo[]>
   - List all local branches with metadata

**Commit operations:**
8. stageFiles(files: string[] | 'all'): Promise<void>
   - Stage specific files or all changes

9. commit(message: string): Promise<string>
   - Create commit, return commit hash

10. getLog(limit?: number): Promise<CommitInfo[]>
    - Get commit history

**Diff operations:**
11. diff(options?: DiffOptions): Promise<string>
    - Get diff of changes (staged, unstaged, between refs)

12. diffStat(options?: DiffOptions): Promise<DiffStat>
    - Get diff statistics (files changed, insertions, deletions)

**Merge operations:**
13. merge(branch: string, options?: MergeOptions): Promise<MergeResult>
    - Merge branch into current
    - Return conflict info if any

14. abortMerge(): Promise<void>
    - Abort in-progress merge

**Types:**
```typescript
interface GitStatus {
  current: string;       // Current branch
  tracking?: string;     // Remote tracking branch
  staged: string[];      // Staged files
  modified: string[];    // Unstaged modifications
  untracked: string[];   // Untracked files
  conflicted: string[];  // Conflict files
  ahead: number;         // Commits ahead of remote
  behind: number;        // Commits behind remote
}

interface BranchInfo {
  name: string;
  current: boolean;
  commit: string;        // Latest commit hash
}

interface CommitInfo {
  hash: string;
  message: string;
  author: string;
  date: Date;
}

interface DiffOptions {
  staged?: boolean;      // Staged changes only
  ref1?: string;         // Compare from ref
  ref2?: string;         // Compare to ref (default HEAD)
}

interface DiffStat {
  filesChanged: number;
  insertions: number;
  deletions: number;
  files: { path: string; insertions: number; deletions: number }[];
}

interface MergeResult {
  success: boolean;
  mergeCommit?: string;
  conflicts?: string[];  // Files with conflicts
}

interface GitServiceOptions {
  baseDir: string;
  binary?: string;       // Custom git binary path
}
```
  </behavior>
  <implementation>
Use simple-git library:
- simpleGit({ baseDir, binary })
- Provides promise-based API for all git operations

Constructor takes GitServiceOptions:
- baseDir: repository root path
- binary: optional custom git binary (for Electron)

Create custom error types:
- GitError (base)
- NotARepositoryError
- BranchNotFoundError
- MergeConflictError
- CommitError

All operations should:
1. Validate repository exists before operations
2. Use proper error handling with typed exceptions
3. Normalize paths with pathe
  </implementation>
</feature>

<verification>
```bash
pnpm test -- src/infrastructure/git/GitService.test.ts
```
Test suite must pass with 15+ tests covering:
- Repository detection
- Branch CRUD operations
- Staging and committing
- Diff operations (staged/unstaged)
- Status reporting
- Merge (success and conflict scenarios)
- Custom binary path support

Tests should use a temporary git repository created in beforeEach.
</verification>

<success_criteria>
- RED: Failing tests written for all GitService methods
- GREEN: Implementation passes all tests
- REFACTOR: Code cleaned up, no duplication
- All commits present (test → feat → refactor if needed)
- Coverage ≥ 80% for GitService
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-06-SUMMARY.md` with:
- RED: What tests were written, why they failed initially
- GREEN: What implementation made them pass
- REFACTOR: What cleanup was done (if any)
- Commits: List of commits produced
</output>
