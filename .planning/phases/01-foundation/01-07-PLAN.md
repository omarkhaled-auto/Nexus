---
phase: 01-foundation
plan: 07
type: tdd
depends_on: ["01-06"]
files_modified: [src/infrastructure/git/WorktreeManager.ts, src/infrastructure/git/WorktreeManager.test.ts]
---

<objective>
Implement WorktreeManager using Test-Driven Development.

Purpose: Create worktree isolation management that enables multiple agents to work in parallel without conflicts - a core Nexus innovation.
Output: Fully tested WorktreeManager with create, remove, list, and cleanup operations.
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-plan.md
./.claude/get-shit-done/templates/summary.md
./.claude/get-shit-done/references/tdd.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation/01-CONTEXT.md

**Reference specifications:**
- Master Book Section 4.2 BUILD-003: Infrastructure Layer (WorktreeManager ~3h)
- Depends on: GitService

**Key implementation notes from Master Book:**
- Store metadata in .nexus/worktrees/registry.json
- Branch naming pattern: nexus/task/{taskId}/{timestamp}
- Worktree path pattern: .nexus/worktrees/{taskId}
- Target: 10 tests, 200-250 LOC

**Prior plan reference:**
@.planning/phases/01-foundation/01-06-SUMMARY.md (when available)
</context>

<feature>
  <name>WorktreeManager</name>
  <files>src/infrastructure/git/WorktreeManager.ts, src/infrastructure/git/WorktreeManager.test.ts</files>
  <behavior>
WorktreeManager provides git worktree isolation for agents:

**Worktree operations:**
1. createWorktree(taskId: string, baseBranch?: string): Promise<WorktreeInfo>
   - Input: task ID, base branch (default: main/master)
   - Output: WorktreeInfo with path, branch, taskId
   - Creates: .nexus/worktrees/{taskId}/ directory
   - Creates: branch nexus/task/{taskId}/{timestamp}
   - Updates: registry.json

2. removeWorktree(taskId: string): Promise<void>
   - Input: task ID
   - Output: void
   - Removes: worktree directory
   - Optionally deletes: associated branch (configurable)
   - Updates: registry.json

3. getWorktree(taskId: string): Promise<WorktreeInfo | null>
   - Input: task ID
   - Output: WorktreeInfo if exists, null otherwise

4. listWorktrees(): Promise<WorktreeInfo[]>
   - Output: Array of all active worktrees

5. cleanup(options?: CleanupOptions): Promise<CleanupResult>
   - Remove stale worktrees (no activity, orphaned)
   - Options: maxAge, force
   - Returns: count of cleaned worktrees

6. getWorktreePath(taskId: string): string
   - Input: task ID
   - Output: absolute path to worktree directory
   - Synchronous helper for path construction

**Registry operations:**
7. loadRegistry(): Promise<WorktreeRegistry>
   - Load registry from .nexus/worktrees/registry.json
   - Create if not exists

8. saveRegistry(registry: WorktreeRegistry): Promise<void>
   - Save registry to disk

**Types:**
```typescript
interface WorktreeInfo {
  taskId: string;
  path: string;          // Absolute path to worktree
  branch: string;        // Branch name
  baseBranch: string;    // Branch it was created from
  createdAt: Date;
  lastActivity?: Date;
  status: 'active' | 'idle' | 'stale';
}

interface WorktreeRegistry {
  version: 1;
  baseDir: string;
  worktrees: Record<string, WorktreeInfo>;
  lastUpdated: Date;
}

interface CleanupOptions {
  maxAge?: number;       // Max idle time in ms (default 1 hour)
  force?: boolean;       // Force removal even if modified
  dryRun?: boolean;      // Just report, don't remove
}

interface CleanupResult {
  removed: string[];     // Task IDs removed
  failed: { taskId: string; error: string }[];
  skipped: string[];     // Task IDs skipped (too recent, modified)
}

interface WorktreeManagerOptions {
  baseDir: string;       // Repository root
  worktreeDir?: string;  // Default: .nexus/worktrees
  gitService: GitService;
}
```

**Path patterns:**
- Worktree dir: {baseDir}/.nexus/worktrees/{taskId}/
- Registry file: {baseDir}/.nexus/worktrees/registry.json
- Branch name: nexus/task/{taskId}/{timestamp}
  </behavior>
  <implementation>
WorktreeManager coordinates GitService and FileSystemService:

Constructor:
- Takes GitService instance (dependency injection)
- Initializes .nexus/worktrees/ directory if not exists
- Loads or creates registry.json

createWorktree:
1. Validate taskId doesn't already have worktree
2. Generate branch name with timestamp
3. Calculate worktree path
4. Use `git worktree add {path} -b {branch}` via GitService or shell
5. Update registry
6. Return WorktreeInfo

removeWorktree:
1. Get worktree info from registry
2. Use `git worktree remove {path}` via shell
3. Optionally delete branch
4. Update registry

cleanup:
1. Load registry
2. Check each worktree for staleness (no activity > maxAge)
3. Remove stale worktrees
4. Update registry
5. Return results

Use atomic file operations for registry (write to temp, rename).
  </implementation>
</feature>

<verification>
```bash
pnpm test -- src/infrastructure/git/WorktreeManager.test.ts
```
Test suite must pass with 10+ tests covering:
- Create worktree (valid taskId)
- Create worktree (duplicate taskId rejected)
- Remove worktree
- List worktrees
- Get worktree by taskId
- Cleanup stale worktrees
- Registry persistence
- Branch naming pattern validation
- Path construction

Tests should use temporary git repository with GitService.
</verification>

<success_criteria>
- RED: Failing tests written for all WorktreeManager methods
- GREEN: Implementation passes all tests
- REFACTOR: Code cleaned up, no duplication
- All commits present (test → feat → refactor if needed)
- Coverage ≥ 80% for WorktreeManager
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-07-SUMMARY.md` with:
- RED: What tests were written, why they failed initially
- GREEN: What implementation made them pass
- REFACTOR: What cleanup was done (if any)
- Commits: List of commits produced
</output>
