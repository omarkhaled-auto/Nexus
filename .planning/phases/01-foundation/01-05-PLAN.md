---
phase: 01-foundation
plan: 05
type: tdd
depends_on: ["01-03"]
files_modified: [src/infrastructure/process/ProcessRunner.ts, src/infrastructure/process/ProcessRunner.test.ts]
---

<objective>
Implement ProcessRunner using Test-Driven Development.

Purpose: Create a robust process execution service with timeout support that agents will use to run commands (build, lint, test, git operations).
Output: Fully tested ProcessRunner with run, runStreaming, and kill operations.
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-plan.md
./.claude/get-shit-done/templates/summary.md
./.claude/get-shit-done/references/tdd.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation/01-CONTEXT.md

**Reference specifications:**
- Master Book Section 4.2 BUILD-003: Infrastructure Layer (ProcessRunner ~3h)
- Libraries: execa, tree-kill

**Key implementation notes from Master Book:**
- Timeout support (default 30 seconds)
- Command validation with blocked patterns (rm -rf /, etc.)
- Streaming output support for long-running commands
- Process tree killing support
- Target: 8 tests, 150-200 LOC

**Prior plan reference:**
@.planning/phases/01-foundation/01-03-SUMMARY.md (when available)
</context>

<feature>
  <name>ProcessRunner</name>
  <files>src/infrastructure/process/ProcessRunner.ts, src/infrastructure/process/ProcessRunner.test.ts</files>
  <behavior>
ProcessRunner provides safe command execution for agents:

1. run(command: string, options?: RunOptions): Promise<ProcessResult>
   - Input: command string, options (cwd, timeout, env)
   - Output: { stdout, stderr, exitCode, duration }
   - Error: ProcessError if command fails, TimeoutError if timeout exceeded

2. runStreaming(command: string, options?: StreamingOptions): ProcessHandle
   - Input: command string, options (cwd, timeout, env, onStdout, onStderr)
   - Output: ProcessHandle with { pid, promise, kill() }
   - Streaming callbacks receive output in real-time

3. kill(pid: number): Promise<void>
   - Input: process ID
   - Output: void
   - Uses tree-kill to terminate process and all children

4. isCommandAllowed(command: string): boolean
   - Input: command string
   - Output: true if safe, false if blocked
   - Blocked patterns: rm -rf /, mkfs, dd if=, format, shutdown, reboot

Options:
```typescript
interface RunOptions {
  cwd?: string;           // Working directory
  timeout?: number;       // Milliseconds (default 30000)
  env?: Record<string, string>; // Environment variables
  shell?: boolean;        // Use shell (default true)
}

interface ProcessResult {
  stdout: string;
  stderr: string;
  exitCode: number;
  duration: number;       // Milliseconds
  killed: boolean;        // Was process killed (timeout/manual)
}
```

Error handling:
- NonZero exit code → throw ProcessError with stdout/stderr
- Timeout exceeded → kill process, throw TimeoutError
- Blocked command → throw BlockedCommandError (before execution)
  </behavior>
  <implementation>
Use execa for process execution:
- execa(command, { shell: true, cwd, timeout, env })
- Captures stdout/stderr automatically

Use tree-kill for process termination:
- Kills entire process tree (important for npm/node processes)

Command validation:
- Check against BLOCKED_PATTERNS array before execution
- Patterns include: dangerous filesystem ops, system commands

Create custom error types:
- ProcessError (base) with stdout, stderr, exitCode
- TimeoutError extends ProcessError
- BlockedCommandError extends ProcessError

All executions should:
1. Validate command against blocked patterns first
2. Track start time for duration calculation
3. Handle timeout gracefully with process tree kill
4. Capture full stdout/stderr
  </implementation>
</feature>

<verification>
```bash
pnpm test -- src/infrastructure/process/ProcessRunner.test.ts
```
Test suite must pass with 8+ tests covering:
- Basic command execution (echo, pwd)
- Exit code handling (success vs failure)
- Timeout enforcement
- Blocked command rejection
- Process killing
- Environment variable passing
- Working directory setting
</verification>

<success_criteria>
- RED: Failing tests written for all ProcessRunner methods
- GREEN: Implementation passes all tests
- REFACTOR: Code cleaned up, no duplication
- All commits present (test → feat → refactor if needed)
- Coverage ≥ 80% for ProcessRunner
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-05-SUMMARY.md` with:
- RED: What tests were written, why they failed initially
- GREEN: What implementation made them pass
- REFACTOR: What cleanup was done (if any)
- Commits: List of commits produced
</output>
