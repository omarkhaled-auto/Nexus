---
phase: 01-foundation
plan: 04
type: tdd
depends_on: ["01-03"]
files_modified: [src/infrastructure/file-system/FileSystemService.ts, src/infrastructure/file-system/FileSystemService.test.ts]
---

<objective>
Implement FileSystemService using Test-Driven Development.

Purpose: Create a rock-solid file system abstraction with cross-platform path handling that agents will rely on for all file operations.
Output: Fully tested FileSystemService with readFile, writeFile, exists, glob, watch operations.
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-plan.md
./.claude/get-shit-done/templates/summary.md
./.claude/get-shit-done/references/tdd.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation/01-CONTEXT.md

**Reference specifications:**
- Master Book Section 4.2 BUILD-003: Infrastructure Layer (FileSystemService ~4h)
- Libraries: pathe, fs-extra, chokidar, fast-glob

**Key implementation notes from Master Book:**
- Use `pathe` for cross-platform path handling (NOT path)
- All operations should be async
- Watch capability uses chokidar
- Glob uses fast-glob
- Target: 12 tests, 150-200 LOC

**Prior plan reference:**
@.planning/phases/01-foundation/01-03-SUMMARY.md (when available)
</context>

<feature>
  <name>FileSystemService</name>
  <files>src/infrastructure/file-system/FileSystemService.ts, src/infrastructure/file-system/FileSystemService.test.ts</files>
  <behavior>
FileSystemService provides file operations for agents:

1. readFile(path: string): Promise<string>
   - Input: absolute or relative path
   - Output: file contents as string
   - Error: FileNotFoundError if not exists

2. readFileBuffer(path: string): Promise<Buffer>
   - Input: absolute or relative path
   - Output: file contents as Buffer (for binary)
   - Error: FileNotFoundError if not exists

3. writeFile(path: string, content: string | Buffer): Promise<void>
   - Input: path, content
   - Output: void (creates parent dirs if needed)
   - Error: WriteError if permission denied

4. exists(path: string): Promise<boolean>
   - Input: path
   - Output: true if exists, false otherwise

5. isDirectory(path: string): Promise<boolean>
   - Input: path
   - Output: true if directory, false if file or not exists

6. glob(pattern: string, options?: GlobOptions): Promise<string[]>
   - Input: glob pattern (e.g., '**/*.ts')
   - Output: array of matching paths
   - Options: cwd, ignore patterns

7. mkdir(path: string): Promise<void>
   - Input: directory path
   - Output: void (recursive by default)

8. remove(path: string): Promise<void>
   - Input: file or directory path
   - Output: void (recursive for dirs)

9. copy(src: string, dest: string): Promise<void>
   - Input: source path, destination path
   - Output: void

10. move(src: string, dest: string): Promise<void>
    - Input: source path, destination path
    - Output: void

11. watch(path: string, callback: WatchCallback): WatchDisposer
    - Input: path to watch, callback
    - Output: function to stop watching
    - Callback receives: { type: 'add'|'change'|'unlink', path: string }

All paths normalized with pathe for cross-platform compatibility.
  </behavior>
  <implementation>
Use fs-extra for file operations (readFile, writeFile, ensureDir, remove, copy, move).
Use pathe for all path operations (join, resolve, dirname, basename, normalize).
Use fast-glob for glob patterns.
Use chokidar for file watching.

Create custom error types:
- FileSystemError (base)
- FileNotFoundError
- WriteError
- GlobError

All methods should:
1. Normalize paths with pathe
2. Handle errors gracefully with typed exceptions
3. Log operations for debugging (optional logger param in constructor)
  </implementation>
</feature>

<verification>
```bash
pnpm test -- src/infrastructure/file-system/FileSystemService.test.ts
```
Test suite must pass with 12+ tests covering:
- Basic read/write operations
- Non-existent file handling
- Directory operations
- Glob patterns
- Watch subscription/disposal
- Cross-platform path normalization
</verification>

<success_criteria>
- RED: Failing tests written for all FileSystemService methods
- GREEN: Implementation passes all tests
- REFACTOR: Code cleaned up, no duplication
- All commits present (test → feat → refactor if needed)
- Coverage ≥ 80% for FileSystemService
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-04-SUMMARY.md` with:
- RED: What tests were written, why they failed initially
- GREEN: What implementation made them pass
- REFACTOR: What cleanup was done (if any)
- Commits: List of commits produced
</output>
