---
phase: 04-event-system
plan: 02
type: execute
depends_on: ["04-01"]
files_modified: [src/events/EventHistory.ts, src/events/EventHistory.test.ts, src/events/EventLogger.ts, src/events/EventLogger.test.ts, src/events/index.ts]
---

<objective>
Implement event history tracking and logging for observability.

Purpose: Enable debugging, monitoring, and replay capabilities by recording event history and providing structured logging.
Output: EventHistory for in-memory event storage with query capabilities, EventLogger for persistent logging.
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-plan.md
./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-event-system/04-01-SUMMARY.md
@src/events/EventBus.ts
@src/types/events.ts

**Tech stack available:** TypeScript, Vitest
**Established patterns:** Singleton pattern (EventBus), TDD

**From 04-01:**
- EventBus singleton with emit/subscribe
- NexusEvent shape with id, type, timestamp, payload, source, correlationId

**Requirements from architecture:**
- Event history tracking (last N events)
- Event filtering by type, time range, correlation ID
- Event log persistence for observability
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement EventHistory with circular buffer</name>
  <files>src/events/EventHistory.ts, src/events/EventHistory.test.ts</files>
  <action>
    Create EventHistory class that:
    1. Stores last N events (default: 1000, configurable)
    2. Uses circular buffer pattern (overwrite oldest when full)
    3. Provides query methods:
       - `getAll(): NexusEvent[]` - all stored events
       - `getByType(type: EventType): NexusEvent[]` - filter by type
       - `getByCorrelationId(id: string): NexusEvent[]` - filter by correlation
       - `getInRange(start: Date, end: Date): NexusEvent[]` - time range filter
       - `getLast(n: number): NexusEvent[]` - most recent N events
       - `clear(): void` - clear history
       - `size(): number` - current event count
    4. Auto-subscribes to EventBus using onAny() in constructor
    5. Provides static getInstance() for singleton access

    Tests to write:
    - Stores events up to maxSize
    - Overwrites oldest when buffer full (circular)
    - getByType filters correctly
    - getByCorrelationId returns related events
    - getInRange respects time bounds
    - getLast returns most recent
    - clear() empties history
    - Auto-subscribes to EventBus on creation
  </action>
  <verify>pnpm test -- --testNamePattern "EventHistory" passes (12+ tests)</verify>
  <done>EventHistory stores, queries, and manages event history with circular buffer</done>
</task>

<task type="auto">
  <name>Task 2: Implement EventLogger for persistent logging</name>
  <files>src/events/EventLogger.ts, src/events/EventLogger.test.ts</files>
  <action>
    Create EventLogger class that:
    1. Logs events to configurable output (console, file, callback)
    2. Supports log levels: debug, info, warn, error
    3. Maps event types to log levels:
       - error level: *:failed, *:error, system:error
       - warn level: *:blocked, *:escalated, system:warning
       - info level: *:completed, *:started, *:created
       - debug level: *:progress, *:updated, all others
    4. Formats events as structured JSON lines
    5. Supports filtering (only log certain event types or levels)
    6. Methods:
       - `constructor(options: LoggerOptions)` - configure output and level
       - `start(): void` - begin logging (subscribes to EventBus)
       - `stop(): void` - stop logging (unsubscribes)
       - `setLevel(level: LogLevel): void` - change minimum level
       - `addFilter(types: EventType[]): void` - only log these types
       - `removeFilter(): void` - log all types

    LoggerOptions:
    ```typescript
    interface LoggerOptions {
      output: 'console' | 'callback';
      callback?: (entry: LogEntry) => void;
      minLevel: LogLevel;
      includePayload: boolean; // whether to include full payload
    }
    ```

    Tests to write:
    - Logs events at correct level
    - Respects minLevel filter
    - Formats as structured JSON
    - start/stop controls subscription
    - Filter limits logged event types
    - Callback receives LogEntry
    - Does not throw if output fails
  </action>
  <verify>pnpm test -- --testNamePattern "EventLogger" passes (10+ tests)</verify>
  <done>EventLogger provides configurable event logging with level filtering</done>
</task>

<task type="auto">
  <name>Task 3: Update module exports and integration</name>
  <files>src/events/index.ts</files>
  <action>
    Update src/events/index.ts to export:
    - EventBus (from 04-01)
    - EventHistory (new)
    - EventLogger (new)
    - All types (NexusEvent, EventType, EventPayload, etc.)

    Ensure EventHistory auto-initializes singleton when EventBus is used.
    Add convenience function: `getEventHistory(): EventHistory`
  </action>
  <verify>Import { EventBus, EventHistory, EventLogger } from '@/events' works</verify>
  <done>All event system components exported from single entry point</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `pnpm test -- --testNamePattern "Event"` - all event tests pass
- [ ] `pnpm typecheck` - no TypeScript errors
- [ ] `pnpm eslint src/events/` - no lint errors
- [ ] EventHistory captures events from EventBus automatically
- [ ] EventLogger can log to console and callbacks
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- EventHistory provides queryable event storage
- EventLogger provides filtered, leveled logging
- 22+ total tests for this plan
</success_criteria>

<output>
After completion, create `.planning/phases/04-event-system/04-02-SUMMARY.md`:

# Phase 04-02: Event Logging & History Summary

**[Substantive one-liner]**

## Accomplishments
- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified
- `path/to/file.ts` - Description

## Decisions Made
[Key decisions and rationale, or "None"]

## Issues Encountered
[Problems and resolutions, or "None"]

## Next Step
Ready for 04-03-PLAN.md (IPC Bridge)
</output>
