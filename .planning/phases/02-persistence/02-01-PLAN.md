---
phase: 02-persistence
plan: 01
type: tdd
depends_on: []
files_modified: [src/persistence/state/StateManager.ts, src/persistence/state/StateManager.test.ts, src/persistence/checkpoints/CheckpointManager.ts, src/persistence/checkpoints/CheckpointManager.test.ts, src/adapters/StateFormatAdapter.ts, src/adapters/StateFormatAdapter.test.ts]
---

<objective>
Implement StateManager, CheckpointManager, and StateFormatAdapter using TDD.

Purpose: Provide reliable state persistence with checkpoint/recovery capabilities and human-readable STATE.md export for debugging and session continuity.
Output: Working services for state save/load, checkpoint create/restore, and STATE.md format conversion.
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-plan.md
./.planning/phases/02-persistence/summary.md
./.claude/get-shit-done/references/tdd.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 1 context:
@.planning/phases/01-foundation/01-08-SUMMARY.md

# Database schema and client:
@src/persistence/database/schema.ts
@src/persistence/database/DatabaseClient.ts

# Reference implementations (TDD patterns):
@src/infrastructure/file-system/FileSystemService.ts
@src/infrastructure/git/GitService.ts

**Tech stack available:** TypeScript 5.9+, Drizzle ORM, better-sqlite3, Vitest, zod
**Established patterns:**
- TDD red-green-refactor
- Error hierarchy with Object.setPrototypeOf
- Service options via constructor
- Drizzle ORM for database operations

**Database tables available:**
- projects, features, subFeatures, tasks, agents, checkpoints, requirements, metrics, sessions

**Constraining decisions:**
- Phase 01-08: Use WAL mode for SQLite, foreign keys enabled
- Phase 01-08: Drizzle ORM for type-safe queries
</context>

<feature>
  <name>StateManager + CheckpointManager + StateFormatAdapter</name>
  <files>src/persistence/state/StateManager.ts, src/persistence/state/StateManager.test.ts, src/persistence/checkpoints/CheckpointManager.ts, src/persistence/checkpoints/CheckpointManager.test.ts, src/adapters/StateFormatAdapter.ts, src/adapters/StateFormatAdapter.test.ts</files>
  <behavior>
**Master Book Reference:** BUILD-005 (Section 4.3)

## StateManager

Manages project state persistence to database.

**Core behaviors to test:**

1. **Custom Error Types:**
   - StateError base class
   - StateNotFoundError with projectId property
   - StateValidationError with errors array property

2. **State Operations:**
   - saveState(state: NexusState) persists full project state to database
   - saveState creates project record if not exists
   - saveState updates features, tasks, agents atomically (transaction)
   - loadState(projectId: string) returns NexusState or null
   - loadState hydrates full state with features, tasks, agents
   - updateState(projectId: string, update: Partial<NexusState>) partial update
   - updateState throws StateNotFoundError if project not found
   - deleteState(projectId: string) removes project and cascades

3. **Auto-save:**
   - enableAutoSave(projectId: string, intervalMs?: number) starts auto-save timer
   - disableAutoSave(projectId: string) stops auto-save
   - Auto-save persists dirty state on interval (default 30s)

4. **Constructor:**
   - Accepts database client
   - Accepts optional logger

**NexusState Interface:**
```typescript
interface NexusState {
  projectId: string;
  project: Project;
  features: Feature[];
  tasks: Task[];
  agents: Agent[];
  status: 'planning' | 'executing' | 'paused' | 'completed' | 'failed';
  currentPhase?: string;
  lastCheckpointId?: string;
}
```

## CheckpointManager

Creates and restores state snapshots for recovery.

**Core behaviors to test:**

1. **Custom Error Types:**
   - CheckpointError base class
   - CheckpointNotFoundError with checkpointId property
   - RestoreError with checkpointId and reason properties

2. **Checkpoint Operations:**
   - createCheckpoint(projectId: string, reason: string) creates checkpoint
   - createCheckpoint captures current git commit hash
   - createCheckpoint serializes full state to JSON
   - createCheckpoint returns Checkpoint with id, timestamp
   - restoreCheckpoint(checkpointId: string) restores state
   - restoreCheckpoint throws CheckpointNotFoundError
   - restoreCheckpoint optionally restores git state (git checkout)
   - listCheckpoints(projectId: string) returns checkpoints ordered by date desc
   - deleteCheckpoint(checkpointId: string) removes checkpoint

3. **Automatic Checkpoints:**
   - createAutoCheckpoint(projectId: string, trigger: string) for system events
   - Triggers: 'phase_complete', 'task_failed', 'qa_exhausted', 'human_request'

4. **Constructor:**
   - Accepts database client, StateManager, GitService
   - Accepts optional logger

## StateFormatAdapter

Converts between internal state and human-readable STATE.md format.

**Core behaviors to test:**

1. **Export:**
   - exportToSTATE_MD(state: NexusState) returns markdown string
   - Export includes project info, current phase, progress metrics
   - Export includes feature list with status
   - Export includes recent task summary
   - Export includes active agents
   - Export is human-readable (not JSON dump)

2. **Import:**
   - importFromSTATE_MD(content: string) parses markdown to NexusState
   - Import handles missing optional sections gracefully
   - Import validates required sections (project, status)
   - Import throws StateValidationError for invalid format

3. **Roundtrip:**
   - Export then import produces equivalent state
   - Import ignores formatting/whitespace differences

**STATE.md Format Example:**
```markdown
# Project State: My App

## Status
- **Phase:** 3 of 8 (Persistence)
- **Status:** executing
- **Progress:** ███████░░░ 35%

## Current Work
- Active task: Implement StateManager
- Assigned agent: coder-001

## Features
| Feature | Status | Progress |
|---------|--------|----------|
| Auth | complete | 100% |
| Dashboard | in_progress | 60% |

## Recent Tasks
- [x] Create database schema
- [x] Implement migrations
- [ ] StateManager (in progress)

## Checkpoints
- Latest: `chk-abc123` (2026-01-14 10:30) - "Before persistence layer"
```
  </behavior>
  <implementation>
**RED Phase:**
Write failing tests for all three services. Start with error types, then StateManager CRUD, then CheckpointManager operations, then StateFormatAdapter conversion.

**GREEN Phase:**

1. **StateManager:**
   - Use Drizzle ORM for all database operations
   - Wrap multi-table updates in transactions
   - Use `db.query.projects.findFirst({ with: { features: true, tasks: true } })` for hydration
   - Store dirty flag for auto-save optimization

2. **CheckpointManager:**
   - Serialize state with JSON.stringify for storage
   - Use GitService.status() to capture current commit
   - Optional git restore via GitService.checkoutBranch() or git reset

3. **StateFormatAdapter:**
   - Use template literals for markdown generation
   - Parse with simple regex/string matching (not full markdown parser)
   - Validate required sections before returning

**REFACTOR Phase:**
- Extract common state hydration logic if duplicated
- Consider caching for frequently accessed state
  </implementation>
</feature>

<verification>
- [ ] `pnpm test -- persistence/state` passes all StateManager tests
- [ ] `pnpm test -- persistence/checkpoints` passes all CheckpointManager tests
- [ ] `pnpm test -- adapters` passes all StateFormatAdapter tests
- [ ] `pnpm typecheck` passes
- [ ] `pnpm lint` passes
- [ ] Coverage >= 80% for all three files
</verification>

<success_criteria>
- Failing tests written and committed (RED)
- Implementation passes all tests (GREEN)
- Refactor complete if needed
- State save/load roundtrip works
- Checkpoint create/restore works
- STATE.md export/import roundtrip is lossless
</success_criteria>

<output>
After completion, create `.planning/phases/02-persistence/02-01-SUMMARY.md` with:
- RED: What tests were written, why they failed
- GREEN: What implementation made them pass
- REFACTOR: What cleanup was done (if any)
- Commits: List of commits produced
</output>
