---
phase: 12-polish
plan: 02
type: execute
depends_on: ["12-01"]
files_modified: [src/renderer/src/stores/settingsStore.ts, src/renderer/src/pages/SettingsPage.tsx, src/renderer/src/App.tsx, src/renderer/src/index.css]
---

<objective>
Create Settings UI with tabbed layout and theme toggle.

Purpose: Let users configure API keys, agent behavior, checkpoints, and UI preferences through a polished settings interface.
Output: SettingsPage with tabs (LLM, Agents, Checkpoints, UI, Projects), Zustand store synced with main process, working theme toggle.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/12-polish/12-CONTEXT.md
@.planning/phases/12-polish/12-RESEARCH.md
@.planning/phases/12-polish/12-01-SUMMARY.md

**Relevant source files:**
@src/renderer/src/stores/uiStore.ts
@src/renderer/src/pages/DashboardPage.tsx
@src/renderer/src/App.tsx
@src/renderer/src/index.css

**From CONTEXT.md:**
- Tabbed sections: LLM, Agents, Checkpoints, UI, Projects
- Vertical tabs on left side, content panel on right
- API key inputs with show/hide toggle
- Save/Cancel buttons

**From RESEARCH.md:**
- Settings flow: UI → Zustand → IPC → electron-store
- Theme: Apply class to <html>, listen for system preference changes
- Avoid theme flash: Apply before React hydration
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create settingsStore with IPC sync</name>
  <files>src/renderer/src/stores/settingsStore.ts, src/renderer/src/stores/index.ts</files>
  <action>
Create src/renderer/src/stores/settingsStore.ts:

1. Import NexusSettingsPublic from shared types
2. Define SettingsState interface:
```typescript
interface SettingsState {
  settings: NexusSettingsPublic | null
  isLoading: boolean
  isDirty: boolean
  pendingChanges: Partial<NexusSettingsPublic>

  loadSettings: () => Promise<void>
  updateSetting: <K extends keyof NexusSettingsPublic>(
    category: K,
    key: keyof NexusSettingsPublic[K],
    value: unknown
  ) => void
  saveSettings: () => Promise<boolean>
  discardChanges: () => void
  setApiKey: (provider: 'claude' | 'gemini' | 'openai', key: string) => Promise<boolean>
  clearApiKey: (provider: 'claude' | 'gemini' | 'openai') => Promise<boolean>
  resetToDefaults: () => Promise<void>
}
```

3. Implement store:
   - loadSettings: Call window.api.settings.getAll(), set settings
   - updateSetting: Track in pendingChanges, set isDirty true
   - saveSettings: Call window.api.settings.set() for each change, clear pendingChanges
   - discardChanges: Clear pendingChanges, reload from main
   - setApiKey: Call window.api.settings.setApiKey(), reload settings
   - clearApiKey: Call window.api.settings.clearApiKey(), reload settings
   - resetToDefaults: Call window.api.settings.reset(), reload settings

4. Export selector hooks:
   - useSettings()
   - useTheme() — returns settings.ui.theme
   - useHasApiKey(provider)

5. Export from stores/index.ts
  </action>
  <verify>TypeScript compiles, store exports correctly</verify>
  <done>settingsStore syncs with main process via IPC, tracks pending changes</done>
</task>

<task type="auto">
  <name>Task 2: Create SettingsPage with tabbed layout</name>
  <files>src/renderer/src/pages/SettingsPage.tsx, src/renderer/src/App.tsx</files>
  <action>
Create src/renderer/src/pages/SettingsPage.tsx:

1. Layout structure (from CONTEXT.md):
```tsx
<div className="flex h-full">
  {/* Left: Vertical tabs */}
  <nav className="w-48 border-r border-border p-4 space-y-1">
    {tabs.map(tab => <TabButton key={tab.id} ... />)}
  </nav>

  {/* Right: Content panel */}
  <main className="flex-1 p-6 overflow-y-auto">
    {activeTab === 'llm' && <LLMSettings />}
    {activeTab === 'agents' && <AgentSettings />}
    {/* etc */}
  </main>
</div>
```

2. Tab components (inline or separate files):
   - LLMSettings: API key inputs with show/hide toggle (type="password"), default provider select, fallback order
   - AgentSettings: maxParallelAgents (number input), timeout (number), retries (number), autoRetry (checkbox)
   - CheckpointSettings: autoCheckpoint toggle, interval input, max to keep input
   - UISettings: theme select (light/dark/system), sidebar width slider, notifications toggle
   - ProjectSettings: default language input, test framework input, output directory input

3. API key input component:
```tsx
function ApiKeyInput({ provider, hasKey, onSave, onClear }) {
  const [value, setValue] = useState('')
  const [show, setShow] = useState(false)

  return (
    <div className="flex items-center gap-2">
      <Input
        type={show ? 'text' : 'password'}
        value={value}
        onChange={e => setValue(e.target.value)}
        placeholder={hasKey ? '••••••••••••' : 'Enter API key'}
      />
      <Button variant="ghost" onClick={() => setShow(!show)}>
        {show ? <EyeOff /> : <Eye />}
      </Button>
      {value && <Button onClick={() => onSave(value)}>Save</Button>}
      {hasKey && <Button variant="destructive" onClick={onClear}>Clear</Button>}
    </div>
  )
}
```

4. Footer with Save/Cancel/Reset buttons:
```tsx
<footer className="flex justify-end gap-2 p-4 border-t">
  <Button variant="outline" onClick={discardChanges} disabled={!isDirty}>
    Cancel
  </Button>
  <Button onClick={saveSettings} disabled={!isDirty}>
    Save Changes
  </Button>
</footer>
```

5. Add route in App.tsx: `/settings` → SettingsPage
  </action>
  <verify>SettingsPage renders, tabs switch correctly</verify>
  <done>SettingsPage with 5 tabbed sections, API key management, save/cancel flow</done>
</task>

<task type="auto">
  <name>Task 3: Implement theme toggle with system detection</name>
  <files>src/renderer/src/hooks/useTheme.ts, src/renderer/src/App.tsx</files>
  <action>
1. Create src/renderer/src/hooks/useTheme.ts:
```typescript
import { useEffect } from 'react'
import { useSettingsStore } from '../stores/settingsStore'

export function useThemeEffect(): void {
  const theme = useSettingsStore((s) => s.settings?.ui.theme ?? 'system')

  useEffect(() => {
    const root = document.documentElement

    function applyTheme() {
      if (theme === 'system') {
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches
        root.classList.toggle('dark', prefersDark)
      } else {
        root.classList.toggle('dark', theme === 'dark')
      }
    }

    applyTheme()

    // Listen for system preference changes
    const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)')
    const handler = () => {
      if (theme === 'system') applyTheme()
    }
    mediaQuery.addEventListener('change', handler)

    return () => mediaQuery.removeEventListener('change', handler)
  }, [theme])
}
```

2. Call useThemeEffect() in App.tsx root component

3. In SettingsPage UISettings section, add theme select:
```tsx
<Select
  value={settings.ui.theme}
  onValueChange={(value) => updateSetting('ui', 'theme', value)}
>
  <SelectItem value="light">Light</SelectItem>
  <SelectItem value="dark">Dark</SelectItem>
  <SelectItem value="system">System</SelectItem>
</Select>
```

4. Verify existing dark theme CSS variables in index.css work (already defined from Phase 5)
  </action>
  <verify>Theme toggle works: light/dark/system all apply correct styles</verify>
  <done>Theme toggle persists to settings, system preference detection works</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `pnpm run build:electron` succeeds
- [ ] `pnpm run typecheck` passes
- [ ] SettingsPage renders at /settings route
- [ ] All 5 tabs work (LLM, Agents, Checkpoints, UI, Projects)
- [ ] API key save/clear works
- [ ] Theme toggle applies immediately (no page refresh)
- [ ] System theme detection works
- [ ] Save/Cancel buttons work
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Settings page is functional and polished
- Theme toggle works with system detection
- API keys can be added and removed
- Changes persist across app restarts
</success_criteria>

<output>
After completion, create `.planning/phases/12-polish/12-02-SUMMARY.md`
</output>
